# Release workflow for cargo-dist
# Generated by cargo-dist configuration, manually adapted for RCH
#
# Triggers on version tags (v*) and creates GitHub releases with:
# - Cross-platform binaries (Linux, macOS, Windows)
# - SHA256 checksums
# - Shell/PowerShell installers
# - SBOM via cargo-auditable

name: Release

permissions:
  contents: write

on:
  push:
    tags:
      - 'v[0-9]+.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.1.0)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  # Plan the release - determine what to build
  plan:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
      version: ${{ steps.tag.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - name: Determine tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building release for tag: $TAG (version: $VERSION)"

  # Build for Linux x86_64 (GNU libc)
  build-linux-x86_64:
    needs: plan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-01-01
          targets: x86_64-unknown-linux-gnu
      - uses: Swatinem/rust-cache@v2
      - name: Build
        run: cargo build --release --target x86_64-unknown-linux-gnu
      - name: Package
        run: |
          mkdir -p dist
          cd target/x86_64-unknown-linux-gnu/release
          tar -czf ../../../dist/rch-${{ needs.plan.outputs.tag }}-x86_64-unknown-linux-gnu.tar.gz rch rchd rch-wkr
          cd ../../../dist
          sha256sum rch-${{ needs.plan.outputs.tag }}-x86_64-unknown-linux-gnu.tar.gz > rch-${{ needs.plan.outputs.tag }}-x86_64-unknown-linux-gnu.tar.gz.sha256
      - uses: actions/upload-artifact@v4
        with:
          name: dist-linux-x86_64
          path: dist/*

  # Build for Linux x86_64 (musl - static)
  build-linux-x86_64-musl:
    needs: plan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-01-01
          targets: x86_64-unknown-linux-musl
      - name: Install musl-tools
        run: sudo apt-get update && sudo apt-get install -y musl-tools
      - uses: Swatinem/rust-cache@v2
      - name: Build
        run: cargo build --release --target x86_64-unknown-linux-musl
      - name: Package
        run: |
          mkdir -p dist
          cd target/x86_64-unknown-linux-musl/release
          tar -czf ../../../dist/rch-${{ needs.plan.outputs.tag }}-x86_64-unknown-linux-musl.tar.gz rch rchd rch-wkr
          cd ../../../dist
          sha256sum rch-${{ needs.plan.outputs.tag }}-x86_64-unknown-linux-musl.tar.gz > rch-${{ needs.plan.outputs.tag }}-x86_64-unknown-linux-musl.tar.gz.sha256
      - uses: actions/upload-artifact@v4
        with:
          name: dist-linux-x86_64-musl
          path: dist/*

  # Build for Linux ARM64
  build-linux-aarch64:
    needs: plan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-01-01
          targets: aarch64-unknown-linux-gnu
      - name: Install cross-compilation tools
        run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu
      - uses: Swatinem/rust-cache@v2
      - name: Build
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
        run: cargo build --release --target aarch64-unknown-linux-gnu
      - name: Package
        run: |
          mkdir -p dist
          cd target/aarch64-unknown-linux-gnu/release
          tar -czf ../../../dist/rch-${{ needs.plan.outputs.tag }}-aarch64-unknown-linux-gnu.tar.gz rch rchd rch-wkr
          cd ../../../dist
          sha256sum rch-${{ needs.plan.outputs.tag }}-aarch64-unknown-linux-gnu.tar.gz > rch-${{ needs.plan.outputs.tag }}-aarch64-unknown-linux-gnu.tar.gz.sha256
      - uses: actions/upload-artifact@v4
        with:
          name: dist-linux-aarch64
          path: dist/*

  # Build for macOS x86_64
  build-macos-x86_64:
    needs: plan
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-01-01
          targets: x86_64-apple-darwin
      - uses: Swatinem/rust-cache@v2
      - name: Build
        run: cargo build --release --target x86_64-apple-darwin
      - name: Package
        run: |
          mkdir -p dist
          cd target/x86_64-apple-darwin/release
          tar -czf ../../../dist/rch-${{ needs.plan.outputs.tag }}-x86_64-apple-darwin.tar.gz rch rchd rch-wkr
          cd ../../../dist
          shasum -a 256 rch-${{ needs.plan.outputs.tag }}-x86_64-apple-darwin.tar.gz > rch-${{ needs.plan.outputs.tag }}-x86_64-apple-darwin.tar.gz.sha256
      - uses: actions/upload-artifact@v4
        with:
          name: dist-macos-x86_64
          path: dist/*

  # Build for macOS ARM64 (Apple Silicon)
  build-macos-aarch64:
    needs: plan
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-01-01
          targets: aarch64-apple-darwin
      - uses: Swatinem/rust-cache@v2
      - name: Build
        run: cargo build --release --target aarch64-apple-darwin
      - name: Package
        run: |
          mkdir -p dist
          cd target/aarch64-apple-darwin/release
          tar -czf ../../../dist/rch-${{ needs.plan.outputs.tag }}-aarch64-apple-darwin.tar.gz rch rchd rch-wkr
          cd ../../../dist
          shasum -a 256 rch-${{ needs.plan.outputs.tag }}-aarch64-apple-darwin.tar.gz > rch-${{ needs.plan.outputs.tag }}-aarch64-apple-darwin.tar.gz.sha256
      - uses: actions/upload-artifact@v4
        with:
          name: dist-macos-aarch64
          path: dist/*

  # Build for Windows x86_64
  build-windows-x86_64:
    needs: plan
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-01-01
          targets: x86_64-pc-windows-msvc
      - uses: Swatinem/rust-cache@v2
      - name: Build
        run: cargo build --release --target x86_64-pc-windows-msvc
      - name: Package
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist
          Compress-Archive -Path target/x86_64-pc-windows-msvc/release/rch.exe,target/x86_64-pc-windows-msvc/release/rchd.exe,target/x86_64-pc-windows-msvc/release/rch-wkr.exe -DestinationPath dist/rch-${{ needs.plan.outputs.tag }}-x86_64-pc-windows-msvc.zip
          $hash = (Get-FileHash dist/rch-${{ needs.plan.outputs.tag }}-x86_64-pc-windows-msvc.zip -Algorithm SHA256).Hash.ToLower()
          "$hash  rch-${{ needs.plan.outputs.tag }}-x86_64-pc-windows-msvc.zip" | Out-File -FilePath dist/rch-${{ needs.plan.outputs.tag }}-x86_64-pc-windows-msvc.zip.sha256 -Encoding ascii
      - uses: actions/upload-artifact@v4
        with:
          name: dist-windows-x86_64
          path: dist/*

  # Create installers and publish release
  publish:
    needs:
      - plan
      - build-linux-x86_64
      - build-linux-x86_64-musl
      - build-linux-aarch64
      - build-macos-x86_64
      - build-macos-aarch64
      - build-windows-x86_64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: dist-*
          merge-multiple: true

      - name: Create checksums.txt
        run: |
          cd artifacts
          cat *.sha256 > checksums.txt
          echo "=== checksums.txt ===" && cat checksums.txt

      - name: Create shell installer
        run: |
          cat > artifacts/install.sh << 'INSTALLER'
          #!/bin/sh
          # RCH Installer - Remote Compilation Helper
          set -e

          REPO="Dicklesworthstone/remote_compilation_helper"
          INSTALL_DIR="${INSTALL_DIR:-$HOME/.local/bin}"

          # Detect platform
          OS="$(uname -s)"
          ARCH="$(uname -m)"

          case "$OS" in
              Linux)
                  case "$ARCH" in
                      x86_64) TARGET="x86_64-unknown-linux-gnu" ;;
                      aarch64) TARGET="aarch64-unknown-linux-gnu" ;;
                      *) echo "Unsupported architecture: $ARCH"; exit 1 ;;
                  esac
                  ;;
              Darwin)
                  case "$ARCH" in
                      x86_64) TARGET="x86_64-apple-darwin" ;;
                      arm64) TARGET="aarch64-apple-darwin" ;;
                      *) echo "Unsupported architecture: $ARCH"; exit 1 ;;
                  esac
                  ;;
              *) echo "Unsupported OS: $OS"; exit 1 ;;
          esac

          # Get latest release tag
          if [ -z "$VERSION" ]; then
              VERSION=$(curl -sL "https://api.github.com/repos/$REPO/releases/latest" | grep '"tag_name":' | cut -d'"' -f4)
          fi

          echo "Installing RCH $VERSION for $TARGET..."
          mkdir -p "$INSTALL_DIR"

          # Download and extract
          ARCHIVE="rch-${VERSION}-${TARGET}.tar.gz"
          URL="https://github.com/$REPO/releases/download/${VERSION}/${ARCHIVE}"
          curl -fsSL "$URL" | tar -xz -C "$INSTALL_DIR"

          echo "Installed to $INSTALL_DIR"
          echo "Add $INSTALL_DIR to your PATH if not already present"
          INSTALLER
          chmod +x artifacts/install.sh

      - name: Create PowerShell installer
        run: |
          cat > artifacts/install.ps1 << 'INSTALLER'
          # RCH Installer for Windows
          $ErrorActionPreference = "Stop"

          $Repo = "Dicklesworthstone/remote_compilation_helper"
          $InstallDir = if ($env:INSTALL_DIR) { $env:INSTALL_DIR } else { "$env:LOCALAPPDATA\Programs\rch" }

          # Get latest release
          $Release = Invoke-RestMethod "https://api.github.com/repos/$Repo/releases/latest"
          $Version = $Release.tag_name

          Write-Host "Installing RCH $Version..."

          # Download
          $Archive = "rch-$Version-x86_64-pc-windows-msvc.zip"
          $Url = "https://github.com/$Repo/releases/download/$Version/$Archive"
          $TempFile = Join-Path $env:TEMP $Archive

          Invoke-WebRequest -Uri $Url -OutFile $TempFile

          # Extract
          New-Item -ItemType Directory -Force -Path $InstallDir | Out-Null
          Expand-Archive -Path $TempFile -DestinationPath $InstallDir -Force
          Remove-Item $TempFile

          Write-Host "Installed to $InstallDir"
          Write-Host "Add $InstallDir to your PATH"
          INSTALLER

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.plan.outputs.tag }}
          name: RCH ${{ needs.plan.outputs.tag }}
          draft: false
          prerelease: ${{ contains(needs.plan.outputs.tag, '-') }}
          generate_release_notes: true
          files: |
            artifacts/*.tar.gz
            artifacts/*.zip
            artifacts/*.sha256
            artifacts/checksums.txt
            artifacts/install.sh
            artifacts/install.ps1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
